@page
@model TiendaPromElec.Pages.IndexModel
@{
    ViewData["Title"] = "Catálogo";
}

<div class="text-center mb-4">
    <h1 class="display-4">Nuestro Catálogo</h1>
</div>

<div class="d-flex justify-content-end mb-3">
    <a href="/Cart" class="btn btn-primary position-relative">
        <i class="bi bi-cart-fill"></i> Ver mi Carrito
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-badge">0</span>
    </a>
</div>

<div class="row">
    @foreach (var item in Model.Product)
    {
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                <img src="@item.ImageUrl" class="card-img-top" style="height: 200px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/300?text=Sin+Imagen'">

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">@item.Name</h5>
                    <p class="card-text text-truncate">@item.Description</p>

                    <div class="mt-auto">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 text-success mb-0">@item.Price.ToString("C")</span>
                            <span class="badge bg-secondary">Stock: @item.Stock</span>
                        </div>

                        @if (item.Stock > 0)
                        {
                            <div class="input-group mb-3">
                                <span class="input-group-text">Cant.</span>
                                <input type="number"
                                       id="qty-@item.Id"
                                       class="form-control"
                                       value="1"
                                       min="1"
                                       max="@item.Stock"
                                       oninput="if(parseInt(this.value) > @item.Stock) this.value = @item.Stock; if(this.value < 1) this.value = 1;">
                                <button class="btn btn-outline-primary" onclick="addToCart(@item.Id, '@item.Name', @item.Price, '@item.ImageUrl')">
                                    <i class="bi bi-cart-plus"></i>
                                </button>
                            </div>
                        }
                        else
                        {
                            <button class="btn btn-secondary w-100" disabled>Agotado</button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        updateBadge();

        function addToCart(id, name, price, img) {
            // 1. Obtener cantidad del input específico
            const qtyInput = document.getElementById("qty-" + id);
            const quantity = parseInt(qtyInput.value);

            if (quantity < 1) { alert("Cantidad inválida"); return; }

            // 2. Verificar si ya existe en el carrito
            const existing = cart.find(x => x.productId === id);
            if (existing) {
                existing.quantity += quantity;
            } else {
                // Guardamos info extra (nombre, precio) para mostrarla en la página de Carrito sin llamar a la API
                cart.push({ productId: id, name: name, price: price, quantity: quantity, imageUrl: img });
            }

            // 3. Guardar y notificar
            localStorage.setItem("cart", JSON.stringify(cart));
            updateBadge();
            alert(`Se agregaron ${quantity} unidades de ${name}`);
        }

        function updateBadge() {
            document.getElementById("cart-badge").innerText = cart.length;
        }
    </script>
}